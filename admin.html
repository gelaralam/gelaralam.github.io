<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Kasepuhan Gelaralam</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@400;700&display=swap"
        rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        :root {
            --admin-primary: #2563eb;
            --admin-bg: #f8fafc;
            --admin-sidebar: #1e293b;
            --admin-card: #ffffff;
            --admin-text: #1e293b;
            --admin-accent: #f59e0b;
        }

        body {
            background-color: var(--admin-bg);
            color: var(--admin-text);
            font-family: 'Inter', sans-serif;
            display: flex;
            min-height: 100vh;
            margin: 0;
        }

        /* Sidebar Style */
        .sidebar {
            width: 260px;
            background: var(--admin-sidebar);
            color: white;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
        }

        .sidebar-header {
            padding: 2rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header img {
            height: 32px;
        }

        .sidebar-header span {
            font-weight: 700;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
        }

        .sidebar-nav {
            padding: 1.5rem 0;
            flex-grow: 1;
        }

        .nav-item {
            padding: 0.85rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 12px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            border-left: 4px solid transparent;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .nav-item.active {
            background: rgba(37, 99, 235, 0.1);
            color: white;
            border-left-color: var(--admin-primary);
        }

        .sidebar-footer {
            padding: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Main Content Style */
        .main-content {
            margin-left: 260px;
            flex-grow: 1;
            padding: 2rem 3rem;
            max-width: 1200px;
            width: calc(100% - 260px);
        }

        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .dashboard-title {
            font-family: 'Playfair Display', serif;
            font-size: 2.2rem;
            margin: 0;
            color: #1a1a1a;
        }

        .card {
            background: var(--admin-card);
            border-radius: 12px;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .section-view {
            display: none;
        }

        .section-view.active {
            display: block;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .data-table th {
            text-align: left;
            padding: 1rem;
            background: #f1f5f9;
            font-weight: 600;
            font-size: 0.85rem;
            color: #64748b;
            text-transform: uppercase;
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-family: inherit;
            font-size: 1rem;
        }

        .btn-admin {
            background: var(--admin-primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .btn-admin:hover {
            transform: translateY(-1px);
            filter: brightness(1.1);
        }

        .btn-danger {
            background: #ef4444;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid #e2e8f0;
            color: #64748b;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2.5rem;
            border-radius: 12px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 700;
            background: #dcfce7;
            color: #166534;
        }

        .badge-pending {
            background: #fef9c3;
            color: #854d0e;
        }

        .img-preview-small {
            width: 50px;
            height: 50px;
            border-radius: 4px;
            object-fit: cover;
        }

        .actions-cell {
            display: flex;
            gap: 8px;
        }

        .btn-icon-only {
            padding: 6px;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
            background: white;
            cursor: pointer;
            color: #64748b;
        }

        .btn-icon-only:hover {
            color: var(--admin-primary);
            border-color: var(--admin-primary);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
    </style>
</head>

<body>
    <div class="loading-overlay" id="loading">
        <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
            <i class="fa-solid fa-spinner fa-spin fa-2x" style="color: var(--admin-primary);"></i>
            <span style="font-weight: 600;">Sedang memproses...</span>
        </div>
    </div>

    <aside class="sidebar">
        <div class="sidebar-header">
            <img src="assets/logo.png" alt="Logo">
            <span>KASEPUHAN GELARALAM</span>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-item active" onclick="switchView('blog')">
                <i class="fa-solid fa-newspaper"></i> Blog / Berita
            </div>
            <div class="nav-item" onclick="switchView('budaya')">
                <i class="fa-solid fa-masks-theater"></i> Upacara Adat
            </div>
            <div class="nav-item" onclick="switchView('timeline')">
                <i class="fa-solid fa-calendar-days"></i> Jadwal Adat
            </div>
            <div class="nav-item" onclick="switchView('gallery')">
                <i class="fa-solid fa-images"></i> Galeri Foto
            </div>
            <div class="nav-item" onclick="switchView('testimonial')">
                <i class="fa-solid fa-comments"></i> Testimoni
            </div>
        </nav>
        <div class="sidebar-footer">
            <a href="index.html" class="nav-item" style="padding: 0; background: transparent;">
                <i class="fa-solid fa-arrow-left"></i> Kembali ke Website
            </a>
            <div class="nav-item" style="padding: 10px 0 0 0; color: #ef4444; background: transparent;"
                onclick="logout()">
                <i class="fa-solid fa-sign-out"></i> Logout
            </div>
        </div>
    </aside>

    <main class="main-content">
        <!-- SEKSI BLOG -->
        <section id="view-blog" class="section-view active">
            <div class="header-actions">
                <h1 class="dashboard-title">Manajemen Blog</h1>
                <button class="btn-admin" onclick="openModal('blog')"><i class="fa-solid fa-plus"></i> Artikel
                    Baru</button>
            </div>
            <div class="card">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Gambar</th>
                            <th>Judul</th>
                            <th>Kategori</th>
                            <th>Tanggal</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="list-blog"></tbody>
                </table>
            </div>
        </section>

        <!-- SEKSI BUDAYA -->
        <section id="view-budaya" class="section-view">
            <div class="header-actions">
                <h1 class="dashboard-title">Upacara Adat</h1>
                <button class="btn-admin" onclick="openModal('budaya')"><i class="fa-solid fa-plus"></i> Tambah
                    Budaya</button>
            </div>
            <div class="card">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Background</th>
                            <th>Judul</th>
                            <th>Deskripsi Panjang</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="list-budaya"></tbody>
                </table>
            </div>
        </section>

        <!-- SEKSI TIMELINE -->
        <section id="view-timeline" class="section-view">
            <div class="header-actions">
                <h1 class="dashboard-title">Jadwal Jadwal Adat</h1>
                <button class="btn-admin" onclick="openModal('timeline')"><i class="fa-solid fa-plus"></i> Jadwal
                    Baru</button>
            </div>
            <div class="card">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Judul Acara</th>
                            <th>Tanggal</th>
                            <th>Deskripsi</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="list-timeline"></tbody>
                </table>
            </div>
        </section>

        <!-- SEKSI GALLERY -->
        <section id="view-gallery" class="section-view">
            <div class="header-actions">
                <h1 class="dashboard-title">Galeri Foto</h1>
                <button class="btn-admin" onclick="openModal('gallery')"><i class="fa-solid fa-plus"></i> Upload
                    Foto</button>
            </div>
            <div class="card">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Foto</th>
                            <th>Judul</th>
                            <th>Kategori</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="list-gallery"></tbody>
                </table>
            </div>
        </section>

        <!-- SEKSI TESTIMONIAL -->
        <section id="view-testimonial" class="section-view">
            <div class="header-actions">
                <h1 class="dashboard-title">Testimoni Pengunjung</h1>
                <button class="btn-admin" onclick="openModal('testimonial')"><i class="fa-solid fa-plus"></i> Tambah
                    Testimoni</button>
            </div>
            <div class="card">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Rating</th>
                            <th>Isi Testimoni</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="list-testimonial"></tbody>
                </table>
            </div>
        </section>

        <!-- Helper: Export Data Fallback -->
        <div class="card" style="margin-top: 4rem; opacity: 0.6;">
            <h2 style="font-size: 1rem; margin-top: 0;">Backup Data (.js manual)</h2>
            <p style="font-size: 0.8rem;">Gunakan ini jika sinkronisasi otomatis bermasalah.</p>
            <div style="display: flex; gap: 10px;">
                <button class="btn-admin btn-outline" onclick="generateManualCode('blog')">Blog</button>
                <button class="btn-admin btn-outline" onclick="generateManualCode('budaya')">Budaya</button>
                <button class="btn-admin btn-outline" onclick="generateManualCode('timeline')">Jadwal</button>
                <button class="btn-admin btn-outline" onclick="generateManualCode('gallery')">Galeri</button>
                <button class="btn-admin btn-outline" onclick="generateManualCode('testimonial')">Testimoni</button>
            </div>
            <div id="output-container" style="display: none; margin-top: 1rem;">
                <pre id="output-code"
                    style="background: #1e293b; color: #fff; padding: 1rem; border-radius: 8px; font-size: 0.8rem; overflow-x: auto; max-height: 200px;"></pre>
                <button class="btn-admin" style="margin-top: 10px;" onclick="copyOutput()">Salin Kode</button>
            </div>
        </div>
    </main>

    <!-- MODAL DINAMIS -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <h2 id="modal-title" style="font-family: 'Playfair Display', serif; margin-top: 0;">Judul Modal</h2>
            <form id="dynamic-form">
                <input type="hidden" id="item-id">
                <input type="hidden" id="item-type">

                <div id="form-fields">
                    <!-- Fields will be injected based on type -->
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="submit" class="btn-admin" style="flex: 1;">Simpan Perubahan</button>
                    <button type="button" class="btn-admin btn-outline" onclick="closeModal()">Batal</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'https://data.gelaralam.id/api';
        let currentType = 'blog';
        let allData = {
            blog: [],
            budaya: [],
            timeline: [],
            gallery: [],
            testimonial: []
        };
        const token = localStorage.getItem('paseto_token');

        // Initial security check
        if (!token) {
            alert('Silakan login terlebih dahulu.');
            window.location.href = 'index.html';
        }

        // --- NAVIGATION ---
        function switchView(type) {
            currentType = type;
            document.querySelectorAll('.section-view').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            document.getElementById(`view-${type}`).classList.add('active');

            // Find the nav item and set active
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                if (item.getAttribute('onclick') && item.getAttribute('onclick').includes(type)) {
                    item.classList.add('active');
                }
            });

            fetchData(type);
        }

        function toggleLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }

        // --- DATA OPERATIONS ---
        async function fetchData(type) {
            toggleLoading(true);
            try {
                const response = await fetch(`${API_BASE}/${type}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    allData[type] = await response.json();
                    renderTable(type);
                } else {
                    console.error(`Gagal mengambil data ${type}`);
                }
            } catch (err) {
                console.error(err);
            } finally {
                toggleLoading(false);
            }
        }

        function renderTable(type) {
            const container = document.getElementById(`list-${type}`);
            container.innerHTML = '';

            allData[type].forEach(item => {
                const tr = document.createElement('tr');

                if (type === 'blog') {
                    tr.innerHTML = `
                        <td><img src="${item.image}" class="img-preview-small"></td>
                        <td style="font-weight: 600;">${item.title}</td>
                        <td><span class="badge">${item.category}</span></td>
                        <td>${item.day} ${item.month} ${item.year}</td>
                    `;
                } else if (type === 'budaya') {
                    tr.innerHTML = `
                        <td><img src="${item.b}" class="img-preview-small"></td>
                        <td style="font-weight: 600;">${item.title}</td>
                        <td><div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.d}</div></td>
                    `;
                } else if (type === 'timeline') {
                    tr.innerHTML = `
                        <td style="font-weight: 600;">${item.title}</td>
                        <td>${item.date}</td>
                        <td>${item.description}</td>
                    `;
                } else if (type === 'gallery') {
                    tr.innerHTML = `
                        <td><img src="${item.img}" class="img-preview-small"></td>
                        <td style="font-weight: 600;">${item.title}</td>
                        <td><span class="badge">${item.cat}</span></td>
                    `;
                } else if (type === 'testimonial') {
                    tr.innerHTML = `
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <img src="${item.photo}" class="img-preview-small" style="border-radius: 50%;">
                                <div><strong>${item.name}</strong><br><small>${item.origin}</small></div>
                            </div>
                        </td>
                        <td style="color: #f59e0b;">${'â˜…'.repeat(item.stars)}</td>
                        <td><div style="max-width: 400px; line-height: 1.4; font-size: 0.85rem;">${item.content || item.text}</div></td>
                        <td>${item.approved ? '<span class="badge">AKTIF</span>' : '<span class="badge badge-pending">PENDING</span>'}</td>
                    `;
                }

                // Action Common
                const tdActions = document.createElement('td');
                tdActions.className = 'actions-cell';

                // Add unique actions for testimonial
                if (type === 'testimonial') {
                    const btnApprove = document.createElement('button');
                    btnApprove.className = 'btn-icon-only';
                    btnApprove.innerHTML = item.approved ? '<i class="fa-solid fa-eye-slash"></i>' : '<i class="fa-solid fa-check"></i>';
                    btnApprove.title = item.approved ? 'Sembunyikan' : 'Tampilkan';
                    btnApprove.onclick = () => toggleApproval(item.id, !item.approved);
                    tdActions.appendChild(btnApprove);
                }

                const btnEdit = document.createElement('button');
                btnEdit.className = 'btn-icon-only';
                btnEdit.innerHTML = '<i class="fa-solid fa-pen-to-square"></i>';
                btnEdit.onclick = () => editItem(type, item);

                const btnDel = document.createElement('button');
                btnDel.className = 'btn-icon-only';
                btnDel.style.color = '#ef4444';
                btnDel.innerHTML = '<i class="fa-solid fa-trash-can"></i>';
                btnDel.onclick = () => deleteItem(type, item.id);

                tdActions.appendChild(btnEdit);
                tdActions.appendChild(btnDel);
                tr.appendChild(tdActions);
                container.appendChild(tr);
            });
        }

        // --- FORM LOGIC ---
        function openModal(type) {
            document.getElementById('item-type').value = type;
            document.getElementById('item-id').value = '';
            document.getElementById('modal-title').innerText = `Tambah ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            renderFormFields(type);
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        function renderFormFields(type, data = null) {
            const container = document.getElementById('form-fields');
            container.innerHTML = '';

            const field = (label, id, tag = 'input', typeAttr = 'text', val = '') => `
                <div class="form-group">
                    <label>${label}</label>
                    <${tag} ${tag === 'input' ? `type="${typeAttr}"` : ''} id="f-${id}" required>${tag === 'textarea' ? '' : ''}</${tag}>
                </div>
            `;

            if (type === 'blog') {
                container.innerHTML = `
                    ${field('Judul Artikel', 'title')}
                    <div class="form-group">
                        <label>Kategori</label>
                        <select id="f-category">
                            <option value="BERITA">BERITA</option>
                            <option value="BUDAYA">BUDAYA</option>
                            <option value="EKONOMI">EKONOMI</option>
                        </select>
                    </div>
                    ${field('URL Gambar', 'image')}
                    <div style="display: flex; gap: 10px;">
                        <div style="flex: 1;">${field('Tanggal', 'day', 'input', 'number')}</div>
                        <div style="flex: 1;">${field('Bulan', 'month')}</div>
                        <div style="flex: 1;">${field('Tahun', 'year', 'input', 'number')}</div>
                    </div>
                    <div class="form-group">
                        <label>Isi Artikel (HTML)</label>
                        <textarea id="f-content" rows="8" required></textarea>
                    </div>
                `;
            } else if (type === 'budaya') {
                container.innerHTML = `
                    ${field('Nama Upacara', 'title')}
                    ${field('URL Gambar Latar', 'b')}
                    <div class="form-group">
                        <label>Deskripsi</label>
                        <textarea id="f-d" rows="6" required></textarea>
                    </div>
                `;
            } else if (type === 'timeline') {
                container.innerHTML = `
                    ${field('Judul Acara', 'title')}
                    ${field('Kapan / Tanggal', 'date')}
                    <div class="form-group">
                        <label>Keterangan Singkat</label>
                        <textarea id="f-description" rows="4" required></textarea>
                    </div>
                `;
            } else if (type === 'gallery') {
                container.innerHTML = `
                    ${field('Judul Foto', 'title')}
                    <div class="form-group">
                        <label>Kategori</label>
                        <select id="f-cat">
                            <option value="adat">Upacara Adat</option>
                            <option value="life">Kehidupan</option>
                            <option value="craft">Kerajinan</option>
                        </select>
                    </div>
                    ${field('URL Foto', 'img')}
                `;
            } else if (type === 'testimonial') {
                container.innerHTML = `
                    ${field('Nama Lengkap', 'name')}
                    ${field('Asal Kota', 'origin')}
                    ${field('URL Foto Profil', 'photo')}
                    <div class="form-group">
                        <label>Rating</label>
                        <select id="f-stars">
                            <option value="5">5 Bintang</option>
                            <option value="4">4 Bintang</option>
                            <option value="3">3 Bintang</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Teks Testimoni</label>
                        <textarea id="f-content" rows="4" required></textarea>
                    </div>
                `;
            }

            // Populate values for inputs if editing
            if (data) {
                Object.keys(data).forEach(key => {
                    const el = document.getElementById(`f-${key}`);
                    if (el) {
                        if (el.tagName === 'INPUT' || el.tagName === 'SELECT' || el.tagName === 'TEXTAREA') {
                            el.value = data[key];
                        }
                    }
                });
                // Compatibility for alternate field names
                if (type === 'testimonial' && data.text) {
                    const el = document.getElementById('f-content');
                    if (el) el.value = data.text;
                }
            }
        }

        function editItem(type, data) {
            document.getElementById('item-type').value = type;
            document.getElementById('item-id').value = data.id;
            document.getElementById('modal-title').innerText = `Edit ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            renderFormFields(type, data);
            document.getElementById('modal').classList.add('active');
        }

        document.getElementById('dynamic-form').onsubmit = async (e) => {
            e.preventDefault();
            const type = document.getElementById('item-type').value;
            const id = document.getElementById('item-id').value;

            const payload = {};
            const inputs = e.target.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.id.startsWith('f-')) {
                    const key = input.id.replace('f-', '');
                    payload[key] = input.type === 'number' ? parseInt(input.value) : input.value;
                }
            });

            // Specific fixes for types
            if (type === 'blog') {
                payload.day = parseInt(payload.day);
                payload.year = parseInt(payload.year);
            }
            if (type === 'testimonial') {
                payload.stars = parseInt(payload.stars);
                payload.approved = true; // Updates are always approved
            }

            toggleLoading(true);
            try {
                const method = id ? 'PUT' : 'POST';
                const url = id ? `${API_BASE}/${type}/${id}` : `${API_BASE}/${type}`;

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    closeModal();
                    fetchData(type);
                } else {
                    alert('Gagal menyimpan data.');
                }
            } catch (err) {
                console.error(err);
            } finally {
                toggleLoading(false);
            }
        };

        async function deleteItem(type, id) {
            if (!confirm('Yakin ingin menghapus item ini?')) return;

            toggleLoading(true);
            try {
                const response = await fetch(`${API_BASE}/${type}/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    fetchData(type);
                } else {
                    alert('Gagal menghapus data.');
                }
            } catch (err) {
                console.error(err);
            } finally {
                toggleLoading(false);
            }
        }

        async function toggleApproval(id, status) {
            const item = allData.testimonial.find(t => t.id === id);
            if (!item) return;

            toggleLoading(true);
            try {
                const response = await fetch(`${API_BASE}/testimonial/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ ...item, approved: status })
                });
                if (response.ok) {
                    fetchData('testimonial');
                }
            } catch (err) {
                console.error(err);
            } finally {
                toggleLoading(false);
            }
        }

        // --- UTILS ---
        function generateManualCode(type) {
            let varName = '';
            let data = allData[type];

            if (type === 'blog') varName = 'blogData';
            else if (type === 'budaya') varName = 'budayaData';
            else if (type === 'timeline') varName = 'timelineData';
            else if (type === 'gallery') { varName = 'galleryItems'; data = allData.gallery; }
            else if (type === 'testimonial') { varName = 'testimonialData'; data = allData.testimonial.filter(t => t.approved); }

            // Map data to local file structures if needed (cleaning up API specific fields like ID)
            const cleanData = data.map(item => {
                const copy = { ...item };
                delete copy.id;
                delete copy._id;
                if (type === 'testimonial') delete copy.approved;
                return copy;
            });

            document.getElementById('output-code').innerText = `const ${varName} = ${JSON.stringify(cleanData, null, 4)};`;
            document.getElementById('output-container').style.display = 'block';
        }

        function copyOutput() {
            const text = document.getElementById('output-code').innerText;
            navigator.clipboard.writeText(text);
            alert('Kode berhasil disalin!');
        }

        function logout() {
            localStorage.removeItem('paseto_token');
            window.location.href = 'index.html';
        }

        // --- INIT ---
        window.onload = () => {
            fetchData('blog'); // Default view
        };
    </script>
</body>

</html>